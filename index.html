<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á Prompt ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ Expert Edition (V.6.17 Preamble & Text Note Fix)</title>
    <!-- Bootstrap 5.3.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts (Prompt & Sarabun) -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* Responsive adjustments */
        html, body { overflow-x: hidden; }
        body {
            font-family: 'Prompt', sans-serif;
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            min-height: 100vh;
            padding: 20px 0;
        }
        .container { max-width: 100%; padding-left: 15px; padding-right: 15px; }
        @media (min-width: 992px) { .container { max-width: 960px; } }
        
        .main-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
            overflow: hidden;
            margin-bottom: 20px;
        }
        .card-header-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-bottom: none;
        }
        .form-label { font-weight: 600; color: #2d3436; font-size: 0.95rem; }
        .section-title {
            color: #764ba2;
            font-weight: 700;
            margin-top: 25px;
            margin-bottom: 15px;
            border-left: 4px solid #764ba2;
            padding-left: 10px;
            font-size: 1.1rem;
        }
        .text-danger {
            color: #dc3545 !important;
        }
        /* Buttons */
        .btn-generate {
            background: linear-gradient(45deg, #FF8008, #FFC837);
            border: none;
            color: white;
            font-weight: 600;
            padding: 12px 20px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(255, 128, 8, 0.3);
        }
        .btn-generate:hover {
            transform: translateY(-2px);
            background: linear-gradient(45deg, #FF4500, #FF8C00) !important;
            box-shadow: 0 8px 25px rgba(255, 69, 0, 0.5);
            color: white;
        }
        .btn-materials {
            background: linear-gradient(45deg, #11998e, #38ef7d);
            border: none;
            color: white;
            font-weight: 600;
            padding: 12px 20px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(56, 239, 125, 0.3);
        }
        .btn-materials:hover {
            transform: translateY(-2px);
            background: linear-gradient(45deg, #008080, #20B2AA) !important;
            box-shadow: 0 8px 25px rgba(0, 128, 128, 0.5);
            color: white;
        }
        .btn-io {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #495057;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .btn-io:hover {
            background-color: #e2e6ea;
            border-color: #adb5bd;
            color: #212529;
        }
        .btn-template {
            background-color: #e3f2fd;
            border: 1px solid #90caf9;
            color: #1976d2;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .btn-template:hover {
             background-color: #bbdefb;
             border-color: #64b5f6;
             color: #0d47a1;
        }

        .output-area {
            background-color: #f8f9fa;
            border: 2px dashed #a29bfe;
            border-radius: 10px;
            padding: 15px;
            font-family: 'Sarabun', sans-serif;
            font-size: 0.95rem;
            color: #333;
            min-height: 250px;
            white-space: pre-wrap;
            line-height: 1.6;
        }
        .output-area-materials {
            background-color: #f0fff4; /* Light green tint */
            border: 2px dashed #38ef7d;
            border-radius: 10px;
            padding: 15px;
            font-family: 'Sarabun', sans-serif;
            font-size: 0.95rem;
            color: #333;
            min-height: 200px;
            white-space: pre-wrap;
            line-height: 1.6;
        }
        
        /* Nav Pills (Top Mode) */
        .nav-pills.top-mode {
            background: rgba(0,0,0,0.2);
            border-radius: 50px;
            padding: 4px;
            display: inline-flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .nav-pills.top-mode .nav-link {
            color: rgba(255,255,255,0.7);
            font-weight: 500;
            border-radius: 50px;
            padding: 6px 15px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        .nav-pills.top-mode .nav-link:hover {
            color: #fff;
            background-color: rgba(255,255,255,0.2);
        }
        .nav-pills.top-mode .nav-link.active {
            background-color: #fff;
            color: #764ba2 !important; 
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            opacity: 1;
        }

        /* Material Tabs */
        .nav-tabs .nav-link {
            color: #495057;
            font-weight: 600;
        }
        .nav-tabs .nav-link.active {
            color: #11998e;
            border-bottom: 3px solid #11998e;
        }
        
        /* Highlight Box */
        .highlight-box {
            background-color: #f0f4ff;
            border: 1px solid #dbeafe;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        /* Expert Team Section Styles */
        .expert-box {
            background: linear-gradient(to right, #ffffff, #fdfbfb);
            border: 1px solid #e1e1e1;
            border-left: 4px solid #FF8008; /* Orange accent */
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: none; /* Hidden by default */
        }
        .expert-toggle-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #fff3e0; /* Light Orange */
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            border: 1px solid #ffe0b2;
            transition: all 0.2s;
        }
        .expert-toggle-wrapper:hover {
            background-color: #ffe0b2;
        }
        .expert-check-label {
            cursor: pointer;
            user-select: none;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
        }
        .expert-check-label i {
            width: 20px;
            color: #667eea;
            margin-right: 5px;
        }

        /* Advanced Toggle Wrapper */
        .advanced-tools-toggle {
            font-size: 0.85rem;
            color: #6c757d;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-bottom: 10px;
        }
        .advanced-tools-toggle:hover {
            color: #495057;
        }
        
        @media (max-width: 576px) {
            .card-header-custom { padding: 15px; }
            h3 { font-size: 1.25rem; }
            .section-title { margin-top: 20px; }
            .btn-io, .btn-template { font-size: 0.75rem; padding: 5px 8px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="card main-card">
                <div class="card-header-custom">
                    <div class="row align-items-center">
                        <div class="col-md-5 text-center text-md-start mb-2 mb-md-0">
                            <h3 class="mb-1"><i class="fas fa-user-graduate me-2"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô AI Expert</h3>
                            <small class="op-8">V.6.17 Preamble & Text Note Fix</small>
                        </div>
                        <div class="col-md-7 text-center text-md-end">
                            <div class="d-flex justify-content-center justify-content-md-end align-items-center">
                                <div class="nav nav-pills top-mode" id="pills-tab" role="tablist">
                                    <button class="nav-link mx-1" id="pills-std-tab" data-bs-toggle="pill" data-bs-target="#pills-std" type="button" role="tab" onclick="setMode('standard')">
                                        ‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
                                    </button>
                                    <button class="nav-link active mx-1" id="pills-rasi-tab" data-bs-toggle="pill" data-bs-target="#pills-rasi" type="button" role="tab" onclick="setMode('rasisalai')">
                                        ‡πÅ‡∏ö‡∏ö ‡∏£.‡∏£.‡∏£‡∏≤‡∏©‡∏µ‡πÑ‡∏®‡∏•
                                    </button>
                                    <button class="nav-link mx-1 d-none" id="pills-custom-tab" data-bs-toggle="pill" data-bs-target="#pills-custom" type="button" role="tab" onclick="setMode('custom')">
                                        <i class="fas fa-star me-1"></i> ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á
                                    </button>
                                </div>
                                <button class="btn btn-outline-light btn-sm ms-2 rounded-circle" data-bs-toggle="modal" data-bs-target="#helpModal" title="‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"><i class="fas fa-question"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-3 p-md-4">
                    
                    <!-- Advanced Tools Toggle -->
                    <div class="advanced-tools-toggle">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="advancedModeToggle" onchange="toggleAdvancedTools()">
                            <label class="form-check-label" for="advancedModeToggle"><i class="fas fa-cogs me-1"></i> ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á (Import/Export)</label>
                        </div>
                    </div>

                    <!-- Top Toolbar -->
                    <div id="advancedToolbar" class="d-none flex-wrap justify-content-end gap-2 mb-3 bg-light p-2 rounded border">
                         <div class="btn-group" role="group">
                            <button class="btn btn-template" data-bs-toggle="modal" data-bs-target="#templateImportModal" title="Import Structure"><i class="fas fa-file-upload me-1"></i> ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô (Template)</button>
                            <button class="btn btn-template" onclick="exportTemplate()" title="Export Structure"><i class="fas fa-file-download me-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á</button>
                        </div>
                        <div class="vr"></div>
                        <div class="btn-group" role="group">
                            <button class="btn btn-io" data-bs-toggle="modal" data-bs-target="#importModal" title="Import Data"><i class="fas fa-folder-open me-1"></i> ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Data)</button>
                            <button class="btn btn-io" onclick="exportData()" title="Export Data"><i class="fas fa-download me-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        </div>
                    </div>

                    <form id="promptForm">
                        
                        <!-- 1. ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏©‡∏≤ -->
                        <div class="highlight-box">
                            <div class="row align-items-center mb-3">
                                <div class="col-md-12">
                                    <h5 class="text-primary mb-2 mb-md-0"><i class="fas fa-layer-group me-2"></i>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö</h5>
                                </div>
                                <!-- Language Toggle Removed: Always English Prompt -->
                            </div>
                            
                            <!-- Virtual Team Toggle -->
                            <div class="expert-toggle-wrapper" onclick="toggleExpertMode()">
                                <div class="d-flex align-items-center">
                                    <div class="form-check form-switch me-2 pointer-events-none">
                                        <input class="form-check-input" type="checkbox" id="expertModeToggle">
                                    </div>
                                    <span class="fw-bold text-dark"><i class="fas fa-users-cog me-2"></i>‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏µ‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç (Virtual Expert Team)</span>
                                </div>
                                <i class="fas fa-chevron-down" id="expertToggleIcon"></i>
                            </div>

                            <!-- Virtual Team Configuration -->
                            <div id="expertConfigBox" class="expert-box">
                                <p class="text-danger small mb-2"><i class="fas fa-exclamation-triangle me-1"></i> ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡πÉ‡∏´‡πâ Prompt ‡∏ã‡∏∂‡πà‡∏á‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ AI ‡∏ï‡∏≠‡∏ö‡∏ä‡πâ‡∏≤‡∏•‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</p>
                                <p class="small text-muted mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏°‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì:</p>
                                <div class="row g-2">
                                    <div class="col-6 col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="roleCurriculum" checked disabled>
                                            <label class="form-check-label expert-check-label" for="roleCurriculum">
                                                <i class="fas fa-book"></i> ‡∏ô‡∏±‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="rolePsychologist" checked>
                                            <label class="form-check-label expert-check-label" for="rolePsychologist">
                                                <i class="fas fa-brain"></i> ‡∏à‡∏¥‡∏ï‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡πÄ‡∏î‡πá‡∏Å
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="roleEdTech">
                                            <label class="form-check-label expert-check-label" for="roleEdTech">
                                                <i class="fas fa-laptop-code"></i> ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç AI <span class="text-muted small ms-1">(‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á AI)</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="roleAssessment" checked>
                                            <label class="form-check-label expert-check-label" for="roleAssessment">
                                                <i class="fas fa-clipboard-check"></i> ‡∏ô‡∏±‡∏Å‡∏ß‡∏±‡∏î‡∏ú‡∏• (Rubric/Test)
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="roleMedia" checked>
                                            <label class="form-check-label expert-check-label" for="roleMedia">
                                                <i class="fas fa-pencil-ruler"></i> ‡∏ô‡∏±‡∏Å‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏™‡∏∑‡πà‡∏≠
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row g-3">
                                <div class="col-md-4 col-sm-12">
                                    <label for="teachingModel" class="form-label">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô</label>
                                    <select class="form-select border-primary" id="teachingModel" onchange="toggleOtherInput('teachingModel', 'teachingModelOther')">
                                        <option value="GPAS 5 Steps" selected>GPAS 5 Steps</option>
                                        <option value="Thinking School">Thinking School</option>
                                        <option value="5E (Simplified)">5E ‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠ (‡∏ô‡∏≥-‡∏™‡∏≠‡∏ô-‡∏™‡∏£‡∏∏‡∏õ)</option>
                                        <option value="5E Inquiry-Based">5E Inquiry-Based (5 ‡∏Ç‡∏±‡πâ‡∏ô)</option>
                                        <option value="Problem-Based Learning (PBL)">PBL (‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô)</option>
                                        <option value="Project-Based Learning (PjBL)">PjBL (‡πÇ‡∏Ñ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô)</option>
                                        <option value="STEM Education">STEM Education</option>
                                        <option value="CIPPA Model">CIPPA Model</option>
                                        <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏≠‡∏á)</option>
                                    </select>
                                    <input type="text" class="form-control mt-2 d-none border-primary" id="teachingModelOther" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô...">
                                </div>
                                <div class="col-md-4 col-sm-12">
                                    <label for="teachingTechnique" class="form-label">‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡πÄ‡∏™‡∏£‡∏¥‡∏°</label>
                                    <select class="form-select border-warning" id="teachingTechnique" onchange="toggleOtherInput('teachingTechnique', 'teachingTechniqueOther')">
                                        <option value="Active Learning" selected>Active Learning (‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô)</option>
                                        <option value="Gamification">Gamification (‡πÄ‡∏Å‡∏°)</option>
                                        <option value="Unplugged Coding">Unplugged Coding</option>
                                        <option value="Flipped Classroom">Flipped Classroom</option>
                                        <option value="Think-Pair-Share">Think-Pair-Share</option>
                                        <option value="Jigsaw">Jigsaw (‡∏à‡∏¥‡πä‡∏Å‡∏ã‡∏≠‡∏ß‡πå)</option>
                                        <option value="Role Playing">Role Playing (‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏™‡∏°‡∏°‡∏ï‡∏¥)</option>
                                        <option value="Storytelling">Storytelling (‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á)</option>
                                        <option value="Design Thinking">Design Thinking</option>
                                        <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏≠‡∏á)</option>
                                    </select>
                                    <input type="text" class="form-control mt-2 d-none border-warning" id="teachingTechniqueOther" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡πÄ‡∏™‡∏£‡∏¥‡∏°...">
                                </div>
                                <div class="col-md-4 col-sm-12">
                                    <label for="objectiveFormat" class="form-label text-success">‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå</label>
                                    <select class="form-select border-success" id="objectiveFormat" onchange="toggleOtherInput('objectiveFormat', 'objectiveFormatOther')">
                                        <option value="K-P-A" selected>K-P-A</option>
                                        <option value="K-S-A">K-S-A</option>
                                        <option value="K-P-A-S">K-P-A-S</option>
                                        <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏≠‡∏á)</option>
                                    </select>
                                    <input type="text" class="form-control mt-2 d-none border-success" id="objectiveFormatOther" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå...">
                                </div>
                            </div>
                        </div>

                        <!-- 2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ -->
                        <div class="section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô</div>
                        <div class="row g-3">
                            <div class="col-md-12 col-sm-12">
                                <label for="subjectGroup" class="form-label">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label>
                                <select class="form-select" id="subjectGroup">
                                    <option value="‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ" selected>‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ</option>
                                    <option value="‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå">‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</option>
                                    <option value="‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢">‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</option>
                                    <option value="‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®">‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</option>
                                    <option value="‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏®‡∏≤‡∏™‡∏ô‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°">‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏®‡∏≤‡∏™‡∏ô‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°</option>
                                    <option value="‡∏™‡∏∏‡∏Ç‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏û‡∏•‡∏®‡∏∂‡∏Å‡∏©‡∏≤">‡∏™‡∏∏‡∏Ç‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏û‡∏•‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
                                    <option value="‡∏®‡∏¥‡∏•‡∏õ‡∏∞">‡∏®‡∏¥‡∏•‡∏õ‡∏∞</option>
                                    <option value="‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û">‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</option>
                                    <option value="‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                                </select>
                            </div>

                            <div class="col-md-6 col-sm-12">
                                <label for="teacherName" class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="teacherName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏¢‡∏ä‡∏±‡∏¢‡∏ß‡∏±‡∏í‡∏ô‡πå ..." required>
                            </div>
                            <div class="col-md-6 col-sm-12">
                                <label for="subject" class="form-label">‡∏ß‡∏¥‡∏ä‡∏≤ <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="subject" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì" required>
                            </div>
                            
                            <div class="col-md-3 col-6">
                                <label for="subjectCode" class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤</label>
                                <input type="text" class="form-control" id="subjectCode" placeholder="‡∏ß21101">
                            </div>
                            <div class="col-md-3 col-6">
                                <label for="grade" class="form-label">‡∏ä‡∏±‡πâ‡∏ô</label>
                                <select class="form-select" id="grade">
                                    <optgroup label="‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏•">
                                        <option value="‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏• 1">‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏• 1</option>
                                        <option value="‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏• 2">‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏• 2</option>
                                        <option value="‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏• 3">‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏• 3</option>
                                    </optgroup>
                                    <optgroup label="‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤">
                                        <option value="‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 1">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 1</option>
                                        <option value="‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 2">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 2</option>
                                        <option value="‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 3">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 3</option>
                                        <option value="‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 4">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 4</option>
                                        <option value="‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 5">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 5</option>
                                        <option value="‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 6">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 6</option>
                                    </optgroup>
                                    <optgroup label="‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤">
                                        <option value="‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 1" selected>‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 1</option>
                                        <option value="‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 2">‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 2</option>
                                        <option value="‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 3">‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 3</option>
                                        <option value="‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 4">‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 4</option>
                                        <option value="‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 5">‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 5</option>
                                        <option value="‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 6">‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 6</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="col-md-3 col-6">
                                <label for="semester" class="form-label">‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                                <input type="text" class="form-control" id="semester" placeholder="1">
                            </div>
                            <div class="col-md-3 col-6">
                                <label for="year" class="form-label">‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
                                <input type="text" class="form-control" id="year" placeholder="2569">
                            </div>

                            <div class="col-md-6 col-sm-12">
                                <label for="unitName" class="form-label">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label>
                                <input type="text" class="form-control" id="unitName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢...">
                            </div>
                            <div class="col-md-6 col-sm-12">
                                <label for="topic" class="form-label">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="topic" placeholder="‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á..." required>
                            </div>

                            <div class="col-md-4 col-sm-12">
                                <label for="time" class="form-label">‡πÄ‡∏ß‡∏•‡∏≤</label>
                                <input type="text" class="form-control" id="time" placeholder="‡πÄ‡∏ä‡πà‡∏ô 50 ‡∏ô‡∏≤‡∏ó‡∏µ">
                            </div>
                             <div class="col-md-4 col-6">
                                <label for="credit" class="form-label">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï</label>
                                <input type="text" class="form-control" id="credit" placeholder="1.0">
                            </div>
                            <div class="col-md-4 col-6">
                                <label for="teachDate" class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô</label>
                                <input type="text" class="form-control" id="teachDate" placeholder="‡∏ß/‡∏î/‡∏õ">
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <button type="button" class="btn btn-generate btn-lg w-100" onclick="generatePrompt()">
                                <i class="fas fa-wand-magic-sparkles me-2"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á Prompt ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô (‡∏´‡∏•‡∏±‡∏Å)
                            </button>
                        </div>
                    </form>

                    <hr class="my-4">

                    <!-- Output Section 1: Main Lesson Plan -->
                    <div class="mt-3 position-relative">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="form-label text-muted mb-0"><i class="fas fa-code me-1"></i> ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå Prompt ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô (‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏õ‡πÉ‡∏ä‡πâ)</h6>
                            <button id="copyBtn" class="btn btn-sm btn-outline-dark" onclick="copyToClipboard('outputPrompt', 'copyBtn')">
                                <i class="far fa-copy"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
                            </button>
                        </div>
                        <textarea class="form-control output-area" id="outputPrompt" rows="10" readonly></textarea>
                    </div>

                    <!-- Output Section 2: Materials Generator (New with Tabs) -->
                    <div class="mt-4 pt-3 border-top">
                        <div class="row mb-3">
                            <div class="col-md-12 mb-2">
                                <h5 class="text-success mb-1"><i class="fas fa-file-alt me-2"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á Prompt ‡πÉ‡∏ö‡∏á‡∏≤‡∏ô & ‡πÉ‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ (‡πÄ‡∏™‡∏£‡∏¥‡∏°)</h5>
                                <small class="text-muted">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÅ‡∏¢‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</small>
                            </div>
                            
                            <!-- Visual Style Selection -->
                            <div class="col-md-12 mb-3">
                                <label class="form-label text-muted small fw-bold"><i class="fas fa-paint-brush me-1"></i> ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏£‡∏≤‡∏ü‡∏¥‡∏Å:</label>
                                <div class="d-flex flex-wrap gap-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="visualStyle" id="styleCartoon" value="infographic" checked>
                                        <label class="form-check-label" for="styleCartoon">Infographic/Cartoon (‡∏™‡∏µ)</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="visualStyle" id="styleColoring" value="coloring">
                                        <label class="form-check-label" for="styleColoring">Coloring Page (‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏™‡∏µ)</label>
                                    </div>
                                </div>
                                <small class="text-muted d-block mt-2" style="font-size: 0.8em; color: #dc3545 !important;">
                                    <i class="fas fa-info-circle"></i> ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ChatGPT, Gemini, Midjourney, DALL-E 3 (‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
                                </small>
                            </div>
                            
                            <!-- Material Language Selection -->
                            <div class="col-md-12 mb-3">
                                <label class="form-label text-muted small fw-bold"><i class="fas fa-language me-1"></i> ‡∏†‡∏≤‡∏©‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏∑‡πà‡∏≠ (Output Lang):</label>
                                <div class="d-flex flex-wrap gap-2">
                                    <div class="form-check me-2">
                                        <input class="form-check-input" type="radio" name="matLang" id="matLangTH" value="th" checked>
                                        <label class="form-check-label" for="matLangTH">‡πÑ‡∏ó‡∏¢ üáπüá≠</label>
                                    </div>
                                    <div class="form-check me-2">
                                        <input class="form-check-input" type="radio" name="matLang" id="matLangEN" value="en">
                                        <label class="form-check-label" for="matLangEN">‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© üá¨üáß</label>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-12 text-md-end mt-2">
                                <button type="button" class="btn btn-materials w-100" onclick="generateMaterialsPrompt()">
                                    <i class="fas fa-print me-2"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á Prompt ‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô
                                </button>
                            </div>
                        </div>
                        
                        <!-- Tabs Navigation -->
                        <ul class="nav nav-tabs mb-3" id="materialTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="tab-know" data-bs-toggle="tab" data-bs-target="#content-know" type="button" role="tab"><i class="fas fa-book-open me-1"></i> ‡πÉ‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="tab-work" data-bs-toggle="tab" data-bs-target="#content-work" type="button" role="tab"><i class="fas fa-pencil-alt me-1"></i> ‡πÉ‡∏ö‡∏á‡∏≤‡∏ô</button>
                            </li>
                        </ul>

                        <!-- Tabs Content -->
                        <div class="tab-content" id="materialTabsContent">
                            <!-- Knowledge Sheet Tab -->
                            <div class="tab-pane fade show active" id="content-know" role="tabpanel">
                                <div class="position-relative">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="form-label text-muted mb-0">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ</h6>
                                        <button id="copyKnowBtn" class="btn btn-sm btn-outline-success" onclick="copyToClipboard('outputMaterialsKnow', 'copyKnowBtn')">
                                            <i class="far fa-copy"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
                                        </button>
                                    </div>
                                    <textarea class="form-control output-area-materials" id="outputMaterialsKnow" rows="8" readonly placeholder="‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° '‡∏™‡∏£‡πâ‡∏≤‡∏á Prompt ‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå..."></textarea>
                                </div>
                            </div>
                            <!-- Worksheet Tab -->
                            <div class="tab-pane fade" id="content-work" role="tabpanel">
                                <div class="position-relative">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="form-label text-muted mb-0">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ö‡∏á‡∏≤‡∏ô + ‡πÄ‡∏â‡∏•‡∏¢</h6>
                                        <button id="copyWorkBtn" class="btn btn-sm btn-outline-success" onclick="copyToClipboard('outputMaterialsWork', 'copyWorkBtn')">
                                            <i class="far fa-copy"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
                                        </button>
                                    </div>
                                    <textarea class="form-control output-area-materials" id="outputMaterialsWork" rows="8" readonly placeholder="‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° '‡∏™‡∏£‡πâ‡∏≤‡∏á Prompt ‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå..."></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <p class="text-danger small mt-2 fw-bold mb-0 text-center"><i class="fas fa-exclamation-circle me-1"></i> ** Prompt ‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© (English Native) ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Å‡∏±‡∏ö AI **</p>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Import/Export Modals & Toasts (Standard Layout) -->
<div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="helpModalLabel"><i class="fas fa-info-circle me-2"></i>‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="small text-muted">‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á Prompt ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ AI ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡πÅ‡∏ï‡πà‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏°‡∏≤ (‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô/‡πÉ‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ) ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importModalLabel"><i class="fas fa-folder-open me-2"></i>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Load JSON)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="file" class="form-control" id="jsonFile" accept=".json">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" class="btn btn-primary" onclick="importData()">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="templateImportModal" tabindex="-1" aria-labelledby="templateImportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="templateImportModalLabel"><i class="fas fa-file-code me-2"></i>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <textarea class="form-control mb-3" id="templateJsonText" rows="6" placeholder='{ "name": "My Plan", "structure_th": "..." }'></textarea>
                <input type="file" class="form-control" id="templateJsonFile" accept=".json" onchange="loadTemplateFromFile()">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" class="btn btn-primary" onclick="applyCustomTemplate()">‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏µ‡πâ</button>
            </div>
        </div>
    </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1055;">
    <div id="liveToastGen" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex"><div class="toast-body"><i class="fas fa-magic me-2"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á Prompt ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>
    </div>
    <div id="liveToastCopy" class="toast align-items-center text-white bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex"><div class="toast-body"><i class="fas fa-clipboard-check me-2"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>
    </div>
    <div id="liveToastSave" class="toast align-items-center text-white bg-info border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex"><div class="toast-body"><i class="fas fa-save me-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>
    </div>
    <div id="liveToastError" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex"><div class="toast-body"><i class="fas fa-exclamation-circle me-2"></i> ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>
    </div>
    <div id="liveToastImportSuccess" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex"><div class="toast-body"><i class="fas fa-check-circle me-2"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>
    </div>
    <div id="liveToastImportError" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex"><div class="toast-body"><i class="fas fa-times-circle me-2"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>
    </div>
</div>

<script>
    let currentMode = 'rasisalai'; 
    let isExpertMode = false;
    let customTemplateData = null; 

    // --- MOCK DICTIONARY ---
    const keywords_db = {
        "‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ä‡πà‡∏≤‡∏á": "Workshop Materials, Wood, Metal, Plastic, Hammer, Saw, Drill",
        "‡∏ß‡∏±‡∏™‡∏î‡∏∏": "Materials, Raw materials, Substances",
        "‡∏ß‡∏á‡∏à‡∏£‡πÑ‡∏ü‡∏ü‡πâ‡∏≤": "Electrical Circuit, Battery, Wires, Light bulb, Switch, Schematic diagram",
        "‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏¥‡πÄ‡∏ß‡∏®": "Ecosystem, Forest, Animals, Water stream, Sun, Trees, Nature balance",
        "‡∏ß‡∏±‡∏è‡∏à‡∏±‡∏Å‡∏£‡∏ô‡πâ‡∏≥": "Water Cycle, Rain, Clouds, Ocean, Sun, Evaporation, Condensation",
        "‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏û‡∏∑‡∏ä": "Plant Cell Structure, Chloroplast, Cell wall, Nucleus, Green biology",
        "‡∏≠‡∏≤‡∏£‡∏¢‡∏ò‡∏£‡∏£‡∏°‡∏≠‡∏µ‡∏¢‡∏¥‡∏õ‡∏ï‡πå": "Ancient Egypt Civilization, Pyramids, Pharaoh, Sphinx, Desert, Hieroglyphs",
        "‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á": "Pets, Dog, Cat, Hamster, Rabbit, Cute animals",
        "‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå": "Computer, Keyboard, Screen, Mouse, Technology, Coding",
        "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì": "Computing Science, Coding, Algorithm, Flowchart, Logic",
        "‡∏®‡∏¥‡∏•‡∏õ‡∏∞": "Art, Painting, Colors, Brush, Canvas, Creativity",
        "‡∏î‡∏ô‡∏ï‡∏£‡∏µ": "Music, Notes, Instruments, Melody, Rhythm"
    };

    function translateToEnglish(text) {
        if (!text) return "";
        if (keywords_db[text]) return keywords_db[text];
        for (const [key, value] of Object.entries(keywords_db)) {
            if (text.includes(key)) return value;
        }
        return `${text} (Please visualize this concept in an International context)`;
    }

    const DEFAULT_TEMPLATES = {
        'standard': {
            name: 'Standard',
            structure_th: `1. ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ/‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î\n2. ‡∏™‡∏≤‡∏£‡∏∞‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç\n3. ‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ ({{objectiveFormat}})\n4. ‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ\n5. ‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏ô‡∏∞‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô {{competencySection}}\n6. ‡∏Ñ‡∏∏‡∏ì‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏≠‡∏±‡∏ô‡∏û‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå\n7. ‡∏†‡∏≤‡∏£‡∏∞‡∏ä‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô/‡∏ä‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô (‡∏£‡∏∞‡∏ö‡∏∏‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß‡πÅ‡∏•‡∏∞‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°)\n8. ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ\n9. ‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ/‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ\n10. ‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏• (‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á Rubric ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß 10 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡πÅ‡∏•‡∏∞‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏° 20 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)`,
            structure_en: `1. Standards/Indicators\n2. Concept\n3. Learning Objectives ({{objectiveFormat}})\n4. Content\n5. Core Competencies {{competencySection}}\n6. Desirable Characteristics\n7. Tasks/Assignments\n8. Learning Activities\n9. Media/Resources\n10. Evaluation`
        },
        'rasisalai': {
            name: 'Rasisalai',
            structure_th: `1. ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ/‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î\n   1.1 ‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏≤‡∏á (‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏´‡πâ‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤)\n   1.2 ‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏´‡πâ‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤)\n2. ‡∏™‡∏≤‡∏£‡∏∞‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Concept ‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á)\n3. ‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ (‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏¢‡∏Å‡πÄ‡∏õ‡πá‡∏ô {{objectiveFormat}} ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°)\n4. ‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ (‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å)\n5. ‡∏Ñ‡∏∏‡∏ì‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏≠‡∏±‡∏ô‡∏û‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå (‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á)\n6. ‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏ô‡∏∞‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô {{competencySection}}\n7. ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ:\n   - ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£ "{{model}}" {{technique}}\n   - ‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö **Active Learning** ‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô\n   - ‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏≤‡∏ó‡∏µ ‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏ó‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô (‡πÄ‡∏ä‡πà‡∏ô (10 ‡∏ô‡∏≤‡∏ó‡∏µ))\n   - ‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡∏∏‡∏Å‡∏™‡∏ô‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏≠‡∏ô\n8. ‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•:\n   ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á 4 ‡∏ä‡πà‡∏≠‡∏á ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:\n   - ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà 1: ‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ\n   - ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà 2: ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î\n   - ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà 3: ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠\n   - ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà 4: ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ô\n9. ‡∏™‡∏∑‡πà‡∏≠/‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ`,
            structure_en: `1. Standards/Indicators\n   1.1 Formative Indicators\n   1.2 Summative Indicators\n2. Key Concept\n3. Learning Objectives ({{objectiveFormat}})\n4. Content\n5. Desirable Characteristics\n6. Core Competencies {{competencySection}}\n7. Learning Activities:\n   - Design steps using **{{model}}**.\n   - Explicitly mention **Active Learning** elements in each step.\n   - Allocate specific time in minutes for each step (e.g. (10 mins)).\n   - Integrate fun and technology.\n8. Measurement & Evaluation:\n   - Create a 4-column table: [Objective, Method, Tool, Criteria]\n9. Media/Resources`
        }
    };

    const competencyData = {
      1: { name: "‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏ô‡πÄ‡∏≠‡∏á", relatedSubjects: ["‡∏™‡∏∏‡∏Ç‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏û‡∏•‡∏®‡∏∂‡∏Å‡∏©‡∏≤", "‡∏®‡∏¥‡∏•‡∏õ‡∏∞", "‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û", "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"] },
      2: { name: "‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á", relatedSubjects: ["‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢", "‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ", "‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏®‡∏≤‡∏™‡∏ô‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°"] },
      3: { name: "‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£", relatedSubjects: ["‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢", "‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®"] },
      4: { name: "‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏°‡∏û‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡∏°", relatedSubjects: ["‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û", "‡∏™‡∏∏‡∏Ç‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏û‡∏•‡∏®‡∏∂‡∏Å‡∏©‡∏≤", "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"] },
      5: { name: "‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏°‡πÅ‡∏Ç‡πá‡∏á", relatedSubjects: ["‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏®‡∏≤‡∏™‡∏ô‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°", "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"] },
      6: { name: "‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡∏±‡πà‡∏á‡∏¢‡∏∑‡∏ô", relatedSubjects: ["‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ", "‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û"] }
    };

    function getCompetenciesForSubject(subjectGroup) {
        let relevant = [];
        for (const [key, value] of Object.entries(competencyData)) {
            if (value.relatedSubjects.includes(subjectGroup)) {
                relevant.push(`${value.name}`);
            }
        }
        return relevant.length > 0 ? relevant.join(", ") : "";
    }

    function showToast(elementId) {
        const toastEl = document.getElementById(elementId);
        if (toastEl) {
            // Fix: Use getOrCreateInstance for better BS5 compatibility
            const toast = bootstrap.Toast.getOrCreateInstance(toastEl, { delay: 3000 });
            toast.show();
        }
    }

    function setMode(mode) {
        currentMode = mode;
        const pills = {
            std: document.getElementById('pills-std-tab'),
            rasi: document.getElementById('pills-rasi-tab'),
            custom: document.getElementById('pills-custom-tab')
        };
        Object.values(pills).forEach(p => {
            if(p) {
                p.classList.remove('active', 'bg-white', 'text-primary', 'shadow-sm'); 
                p.style.color = "";
            }
        });
        const activePill = pills[mode === 'custom' ? 'custom' : (mode === 'rasisalai' ? 'rasi' : 'std')];
        if(activePill) {
            activePill.classList.add('active', 'bg-white', 'text-primary', 'shadow-sm');
            activePill.style.color = "#764ba2";
        }
    }

    function toggleAdvancedTools() {
        const toolbar = document.getElementById('advancedToolbar');
        const toggle = document.getElementById('advancedModeToggle');
        if (toggle.checked) {
            toolbar.classList.remove('d-none');
            toolbar.classList.add('d-flex');
        } else {
            toolbar.classList.add('d-none');
            toolbar.classList.remove('d-flex');
        }
    }

    function toggleExpertMode() {
        isExpertMode = !isExpertMode;
        const toggle = document.getElementById('expertModeToggle');
        const box = document.getElementById('expertConfigBox');
        const icon = document.getElementById('expertToggleIcon');
        
        toggle.checked = isExpertMode;
        
        if (isExpertMode) {
            box.style.display = 'block';
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
        } else {
            box.style.display = 'none';
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        }
    }
    
    // REMOVED: toggleImageAdvice since it's now always image mode
    
    document.getElementById('expertModeToggle').addEventListener('click', function(e) {
        e.stopPropagation();
        toggleExpertMode();
    });

    function toggleOtherInput(selectId, inputId) {
        const select = document.getElementById(selectId);
        const input = document.getElementById(inputId);
        if (select.value === 'other') {
            input.classList.remove('d-none');
            input.focus();
        } else {
            input.classList.add('d-none');
        }
    }

    function getSelectOrOther(selectId, inputId) {
        const selectVal = document.getElementById(selectId).value;
        if (selectVal === 'other') return document.getElementById(inputId).value || '';
        return selectVal;
    }

    function getFormValues() {
        const getVal = (id) => document.getElementById(id).value;
        const getCheck = (id) => document.getElementById(id) ? document.getElementById(id).checked : false;
        
        return {
            teacher: getVal('teacherName'),
            subject: getVal('subject'),
            subjectGroup: getVal('subjectGroup'),
            topic: getVal('topic'),
            subjectCode: getVal('subjectCode') || '',
            grade: getVal('grade') || '‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 1',
            semester: getVal('semester') || '',
            year: getVal('year') || '',
            unitName: getVal('unitName') || '',
            time: getVal('time') || '',
            credit: getVal('credit') || '',
            teachDate: getVal('teachDate') || '',
            // FORCE ENGLISH PROMPT
            lang: 'en', 
            model: getSelectOrOther('teachingModel', 'teachingModelOther'),
            technique: getSelectOrOther('teachingTechnique', 'teachingTechniqueOther'),
            objectiveFormat: getSelectOrOther('objectiveFormat', 'objectiveFormatOther'),
            
            mode: currentMode,
            isExpertMode: isExpertMode,
            expertRoles: {
                curriculum: getCheck('roleCurriculum'),
                psychologist: getCheck('rolePsychologist'),
                edTech: getCheck('roleEdTech'),
                assessment: getCheck('roleAssessment'),
                media: getCheck('roleMedia')
            },
            visualStyle: document.querySelector('input[name="visualStyle"]:checked') ? document.querySelector('input[name="visualStyle"]:checked').value : 'infographic',
            // REMOVED outputType
            matLang: document.querySelector('input[name="matLang"]:checked') ? document.querySelector('input[name="matLang"]:checked').value : 'th'
        };
    }

    // --- Import/Export (Reduced for brevity but functional) ---
    function loadTemplateFromFile() {
        const file = document.getElementById('templateJsonFile').files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                document.getElementById('templateJsonText').value = JSON.stringify(JSON.parse(e.target.result), null, 2);
            } catch (err) {
                document.getElementById('templateJsonText').value = e.target.result;
            }
        };
        reader.readAsText(file);
    }

    function applyCustomTemplate() {
        const jsonText = document.getElementById('templateJsonText').value;
        try {
            customTemplateData = JSON.parse(jsonText);
            if(!customTemplateData.structure_th && !customTemplateData.structure_en) throw new Error("Missing structure");
            const customTab = document.getElementById('pills-custom-tab');
            customTab.classList.remove('d-none');
            customTab.click(); 
            bootstrap.Modal.getOrCreateInstance(document.getElementById('templateImportModal')).hide();
            showToast('liveToastImportSuccess');
        } catch (e) { alert("Invalid Template"); }
    }

    function exportTemplate() {
        let templateToExport = (currentMode === 'custom' && customTemplateData) ? customTemplateData : (DEFAULT_TEMPLATES[currentMode] || DEFAULT_TEMPLATES['standard']);
        const blob = new Blob([JSON.stringify(templateToExport, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `template_${currentMode}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        showToast('liveToastSave');
    }

    function setFormValues(data) {
        const setVal = (id, val) => { if(document.getElementById(id)) document.getElementById(id).value = val; };
        setVal('teacherName', data.teacher || '');
        setVal('subject', data.subject || '');
        setVal('topic', data.topic || '');
        setVal('grade', data.grade || '‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 1');
        setVal('semester', data.semester || '');
        setVal('year', data.year || '');
        setVal('unitName', data.unitName || '');
        setVal('time', data.time || '');
        setVal('credit', data.credit || '');
        
        // No lang setter needed (Always EN)

        const setDropdown = (selectId, inputId, val) => {
            const select = document.getElementById(selectId);
            const input = document.getElementById(inputId);
            const options = Array.from(select.options).map(o => o.value);
            if (options.includes(val)) { select.value = val; input.classList.add('d-none'); } 
            else { select.value = 'other'; input.value = val; input.classList.remove('d-none'); }
        };
        setDropdown('teachingModel', 'teachingModelOther', data.model);
        setDropdown('teachingTechnique', 'teachingTechniqueOther', data.technique);
        setDropdown('objectiveFormat', 'objectiveFormatOther', data.objectiveFormat);

        if (data.expertRoles) {
            const setCheck = (id, val) => { if(document.getElementById(id)) document.getElementById(id).checked = val; };
            setCheck('roleCurriculum', data.expertRoles.curriculum);
            setCheck('rolePsychologist', data.expertRoles.psychologist);
            setCheck('roleEdTech', data.expertRoles.edTech);
            setCheck('roleAssessment', data.expertRoles.assessment);
            setCheck('roleMedia', data.expertRoles.media);
        }
        if (data.matLang) {
             const rad = document.querySelector(`input[name="matLang"][value="${data.matLang}"]`);
             if(rad) rad.checked = true;
        }
        // Removed toggleImageAdvice() call
    }

    function exportData() {
        const blob = new Blob([JSON.stringify(getFormValues(), null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `data.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        showToast('liveToastSave');
    }

    function importData() {
        const fileInput = document.getElementById('jsonFile');
        if (!fileInput.files.length) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå JSON');
            return;
        }
        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                setFormValues(JSON.parse(e.target.result));
                const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('importModal'));
                modal.hide();
                // Fix: Add setTimeout to ensure toast shows after modal transition
                setTimeout(() => {
                    showToast('liveToastImportSuccess');
                }, 300);
            } catch (err) { 
                console.error(err);
                showToast('liveToastImportError'); 
            }
        };
        reader.readAsText(file);
    }

    // --- Main Generation Logic ---

    function generatePrompt() {
        const v = getFormValues();
        if (!v.teacher || !v.subject || !v.topic) { showToast('liveToastError'); return; }
        
        let displayedModel = v.model;
        if (v.model === '5E (Simplified)') displayedModel = 'Simplified 5E (Focus on 3 steps: 1.Introduction, 2.Teaching, 3.Conclusion)';

        let techniqueValueEN = v.technique === 'Active Learning' ? 'Active Learning strategies' : `"${v.technique}" technique`;
        let mappedCompetencies = getCompetenciesForSubject(v.subjectGroup);
        let competencySection = mappedCompetencies.length > 0 
            ? `\n**Specific Instruction:**\n- For Core Competencies, select ONLY: **${mappedCompetencies}**\n- Explain how they relate to the lesson content.`
            : `\n### Smart Competency Logic\n- AI to select the most relevant competencies based on the lesson content.`;

        let rolePromptEN = "Role: You are an expert teacher specializing in instructional design and educational technology.";
        let aiInjectEN = "";

        if (isExpertMode) {
            let expertRolesEN = [];
            if (v.expertRoles.curriculum) expertRolesEN.push("Curriculum Designer");
            if (v.expertRoles.psychologist) expertRolesEN.push("Child Psychologist");
            if (v.expertRoles.edTech) { 
                expertRolesEN.push("EdTech Specialist"); 
                aiInjectEN = " and emphasizing AI-integrated teaching methods";
            }
            if (v.expertRoles.assessment) expertRolesEN.push("Assessment Specialist");
            if (v.expertRoles.media) expertRolesEN.push("Instructional Media Designer");
            
            let rolesStrEN = expertRolesEN.length > 0 ? expertRolesEN.join(", ") : "Instructional Design Specialists";
            rolePromptEN = `Role: Act as a "**Virtual Instructional Design Team**" consisting of: ${rolesStrEN}. Your goal is to collaborate to create a high-quality lesson plan${aiInjectEN}.`;
        }

        let template = (currentMode === 'custom' && customTemplateData) ? customTemplateData : (DEFAULT_TEMPLATES[currentMode] || DEFAULT_TEMPLATES['standard']);
        let structure = template.structure_en || template.structure; 
        
        if (v.isExpertMode && v.expertRoles.edTech) {
             structure = structure.replace("Integrate fun and technology", "Integrate fun and technology/AI"); 
        }

        structure = structure
            .replace(/{{objectiveFormat}}/g, v.objectiveFormat)
            .replace(/{{competencySection}}/g, competencySection)
            .replace(/{{model}}/g, displayedModel);

        // --- LANGUAGE CONFIG (The Core Change) ---
        const matLang = v.matLang;
        let langInstructionEN = "**Formal Thai Language (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£)**";
        if (matLang === 'en') langInstructionEN = "**English Language**"; 
        
        // Always Use English Prompt Structure
        let promptText = `${rolePromptEN}
Direct Command: Write the actual full content for the educational materials below immediately. Do not explain the plan. Just write the content.

Task: Write the full text content for educational materials on topic: "${v.topic}".
Subject: ${v.subject}, Grade Level: ${v.grade}.
Output Language: ${langInstructionEN} (Ready to use).

Task: Create an "**Active Learning Lesson Plan**" based on the following details:

**Context:**
- Grade Level: [${v.grade}]
- Semester: [${v.semester}] Academic Year: [${v.year}]
- Subject Group: [${v.subjectGroup}]
- Subject: [${v.subject}] Topic: [${v.topic}]
- Time Duration: [${v.time}] Credit: [${v.credit}]
- Instructor: [${v.teacher}]

**Instructional Design Requirements:**
1. **Model:** Use "**${displayedModel}**" framework.
2. **Technique:** Enhance with **${techniqueValueEN}**.
3. **Objective Format:** Use **${v.objectiveFormat}** model.
4. **AI Integration:** ${v.expertRoles.edTech ? 'You MUST integrate AI tools.' : 'Not required.'}

**IMPORTANT CONSTRAINTS:**
- **Output Language:** The entire lesson plan must be written in ${langInstructionEN} suitable for an official government document.
- **Tone:** Professional, encouraging, and academic.

**Required Structure:**
${structure}

**Additional Requests:**
- Create knowledge sheets and Worksheet with Answer Key.
- Pre-test & Post-test (5 Questions) with Answers and Analysis.
${v.isExpertMode && v.expertRoles.psychologist ? '- **Psychologist Insight:** At the end of the plan, add a brief note explaining why these activities are developmentally appropriate for this age group.' : ''}`;

        document.getElementById('outputPrompt').value = promptText;
        showToast('liveToastGen');
    }

    function generateMaterialsPrompt() {
        const v = getFormValues();
        if (!v.teacher || !v.subject || !v.topic) { showToast('liveToastError'); return; }

        const styleType = v.visualStyle; 
        
        // V6.0 Logic
        const topicEN = translateToEnglish(v.topic);
        const titleKeyword = topicEN.split(',')[0].trim().toUpperCase();

        let compositionLogic = "Mind map style connection, flow of elements.";
        if (v.grade.includes('‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏•') || v.grade.includes('‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 1')) compositionLogic = "Single focal object, large icons, cute style.";
        else if (v.grade.includes('‡∏°‡∏±‡∏ò‡∏¢‡∏°')) compositionLogic = "Exploded view diagram, knolling photography style, organized grid layout.";

        // --- V6.13 FIX: Role Logic Switch ---
        let headerBlock = "";

        if (isExpertMode) {
            // Expert Mode: Use World-Class Role + Direct Action Instruction (V.6.17 Fix)
            headerBlock = `**[Role]** Act as a World-Class Secondary Subject Matter Expert & Academic Designer and Graphic Designer.
**[System Instruction]** IMMEDIATE EXECUTION REQUIRED. Generate the visual output description below. NO conversational text. NO introductions.`;
        } else {
            // Normal Mode: Simple Illustrator Role
            headerBlock = `**[Role]** Professional Educational Illustrator.
**[System Instruction]** Create the visual design described below.`;
        }

        // Fix 1: New Line for Language Instruction
        let contentLang = v.matLang === 'th' ? "Thai (Ensure correct grammar and spelling)" : "English";
        // V.6.17 FIX: Removed typoLangInstruction as per user request

        // Fix 2: Stronger Style Logic
        let stylePromptEN = "";
        let taskDesc = "";
        let colorConstraint = "";
        
        if (styleType === 'coloring') {
            stylePromptEN = "Black and white line art, clear heavy outlines, high contrast, monochrome, colorless, coloring book style for kids, white background, no shading, no greyscale";
            taskDesc = "A printable black and white coloring page worksheet";
            colorConstraint = "**[Color Palette]** BLACK AND WHITE ONLY. STRICTLY NO COLORS.";
        } else {
            stylePromptEN = "Cartoon, Vibrant, Cute, Flat vector illustration";
            taskDesc = "A high-quality, printable Portrait Knowledge Sheet";
            colorConstraint = "";
        }
        
        let negativePrompt = (styleType === 'coloring')
            ? "colors, shading, gradients, greyscale, filled colors, realistic photo, complex background, dark background, 3d render"
            : "black and white, sketch, pencil drawing, messy, rough lines, dark and gloomy, blurry";

        let promptKnow, promptWork;

        // IMAGE MODE (English Native) - Always Force Image Mode (V6.8)
        
        // Construct Header Variable (Topic + Unit)
        let topicFull = v.topic;
        if(v.unitName) topicFull = `${v.unitName}: ${v.topic}`;

        let subHeaderLine = v.unitName ? `- Sub-Header: "${v.unitName}"` : "";

        // V.6.17 FIX: Restore [Text Note] for Knowledge Sheet
        promptKnow = `
${headerBlock}
**[Task]** ${taskDesc} on the topic: "${v.topic}" for Grade Level: ${v.grade}.

**[Content Strategy]**
- Language: ${contentLang}.
- Main Header: "${v.topic}"
${subHeaderLine}
- Summarize "${v.topic}" into key concepts using bullet points.
- Use icons and visual cues to explain complex data.

- Learning Level: Bloom's Taxonomy - Auto (AI Decides based on Grade).
- Tone of Voice: Auto (AI Decides based on Context).

**[Visual Specification]**
- Dimensions: A4 Portrait (Aspect Ratio 210:297).
- Layout Strategy: Dynamic & Adaptive. Organize content logic based on "${v.topic}" for maximum readability.
- Art Style: ${stylePromptEN}.
- Perspective: Flat lay, top-down view (perfectly aligned for printing).
- Typography: Use Clean, Modern, Sans-Serif, Professional Google Fonts supporting Thai (e.g. style of "Krub" Google Font).
${colorConstraint}

**[Text Note]** Include headings and structure text blocks clearly. Use abstract lines, simple geometric blocks, or unreadable scribbles to represent text areas. **DO NOT generate actual readable text paragraphs.**

**[Constraints & Negative Prompt]**
DO NOT include: distorted text, blurred elements, watermark, low resolution, 3d text effects that make reading difficult. 
CRITICAL: Do NOT print layout labels like [TOP], [HEADER], [IMAGE] on the final output. The design must be ready-to-use.
`.trim();

        // *** V6.9 FIX: Use User Custom Template for Worksheet ***
        promptWork = `
${headerBlock}
**[Task]** ${taskDesc} on an A4 portrait background. ${stylePromptEN}, aimed at ${v.grade} students.

**[Header]** Title: '${v.topic}', Subtitle: '${v.unitName}'.

**[Layout: Top & Bottom]**
Top Section (Header Color: a harmonious color automatically selected to match the topic '${v.topic}'): Title a sub-topic related to '${v.topic}', containing:
**[Creative Task]** Create an activity (matching with empty answer boxes, fill-in-blanks) related to '${v.topic}'.
Bottom Section (Header Color: a complementary color to the first section): Title another sub-topic related to '${v.topic}', containing:
**[Creative Task]** Create an activity (questions, drawing space) related to '${v.topic}'.

**[Footer]** Bottom section with writeable lines for: 'Name: __________', 'Class: ...........', 'No: ...'. Use dotted lines for the Class field to allow writing.

**[Worksheet Requirement]** Ensure clear areas for student interaction. CRITICAL: Randomize/Shuffle items in columns so they are NOT aligned. Keep the activity UNSOLVED. 
STRICTLY PROHIBITED: Do not draw any lines, arrows, dashed lines, or connectors between items. 
Instead of lines, provide empty answer boxes next to the left-column items for students to write letters/numbers. The gap between columns must be completely blank. Do NOT fill in answers.

**[Text Note]** Do NOT render complex text. Use placeholders.
**[Typography Style]** Typography style automatically matched to the topic and target audience for maximum readability. Ensure the text aesthetic is legible and appropriate for the grade level.
${colorConstraint}

**[Negative Prompt]**
${negativePrompt}, filled answers, solved problems, messy lines, text paragraphs, complex background.
`.trim();

        document.getElementById('outputMaterialsKnow').value = promptKnow;
        document.getElementById('outputMaterialsWork').value = promptWork;
        showToast('liveToastGen');
    }

    async function copyToClipboard(elementId, btnId) {
        const textarea = document.getElementById(elementId);
        const btn = document.getElementById(btnId);
        const originalHtml = btn.innerHTML;
        if (btn.classList.contains('btn-success') || !textarea.value) return;
        try { await navigator.clipboard.writeText(textarea.value); btn.classList.add('btn-success'); showToast('liveToastCopy'); } 
        catch (err) { textarea.select(); document.execCommand('copy'); btn.classList.add('btn-success'); showToast('liveToastCopy'); }
        setTimeout(() => { btn.innerHTML = originalHtml; btn.classList.remove('btn-success'); }, 2000);
    }

    setMode('rasisalai'); 
    // toggleImageAdvice removed
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
